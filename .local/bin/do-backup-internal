#!/bin/sh
set -e

if [ "$#" -ne 1 ]; then
    echo Need source directory as argument. 1>&2
    exit 1
fi

if ! [ -d "$1" ]; then
    echo Source directory does not exist. 1>&2
    exit 1
fi

source="$1"

host=$(hostname)
if [ -z "$host" ]; then
    echo Could not determine local hostname. 1>&2
    exit 1
fi

options=""
h=$(readlink -f "$HOME")

if [ "$host" = "jet" ] || [ "$host" = "jtriplet-mobl1" ]; then
    target=sftp://jtriplet@otc-chromeos2.jf.intel.com/backups/$host
    options=--ssh-options="-oIdentityFile=$HOME/.ssh/non-agent/id_rsa_backup"
else
    target=s3+http://josh-backup-duplicity-${host}
    options="--s3-use-rrs"
    . "$h/.private/aws"
fi

sudo -E duplicity \
    --name=backup \
    --s3-use-new-style \
    $options \
    --volsize=100 \
    --full-if-older-than=3M \
    --asynchronous-upload \
    --gpg-options="--trust-model=always" \
    --encrypt-key=758E5042E3974BA33A9C1E670ED9A3DF8AFF873D \
    --encrypt-key=337BB4911A6F2CFFDBF49F7690098C0343B115A7 \
    --exclude-if-present=CACHEDIR.TAG \
    --exclude-other-filesystems \
    --exclude="$h/.aptitude/cache" \
    --exclude="$h/.cache" \
    --exclude="$h/.darcs/cache" \
    --exclude="$h/.mozilla/firefox/*/Cache" \
    --include="$h/.mythtv/*.*" \
    --exclude="$h/.mythtv" \
    --exclude="$h/.thumbnails" \
    --exclude="$h/Downloads" \
    "$source" "$target"

sudo -E duplicity \
    --name=backup \
    --s3-use-new-style \
    $options \
    --force \
    remove-all-but-n-full 2 $target
